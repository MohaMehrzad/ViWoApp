# ============================================
# LOGROTATE CONFIGURATION FOR VIWOAPP BACKEND
# ============================================
# This file configures log rotation for ViWoApp Backend logs
#
# Installation:
#   sudo cp logrotate.conf /etc/logrotate.d/viwoapp
#   sudo chown root:root /etc/logrotate.d/viwoapp
#   sudo chmod 644 /etc/logrotate.d/viwoapp
#
# Test configuration:
#   sudo logrotate -d /etc/logrotate.d/viwoapp
#
# Force rotation:
#   sudo logrotate -f /etc/logrotate.d/viwoapp

# ==========================================
# Application Logs
# ==========================================
/var/www/viwoapp/backend/logs/*.log {
    # Rotation schedule
    daily
    
    # Keep 14 days of logs
    rotate 14
    
    # Compress old logs
    compress
    delaycompress
    
    # Don't error if log file is missing
    missingok
    
    # Don't rotate empty logs
    notifempty
    
    # Create new log file with specific permissions
    create 0640 viwoapp viwoapp
    
    # Use date as suffix
    dateext
    dateformat -%Y-%m-%d
    
    # Truncate original file after creating copy
    copytruncate
    
    # Post-rotation script
    postrotate
        # Send signal to reload logs (if needed)
        # systemctl reload viwoapp > /dev/null 2>&1 || true
    endscript
}

# ==========================================
# PM2 Logs
# ==========================================
/var/www/viwoapp/backend/logs/pm2-*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 viwoapp viwoapp
    dateext
    dateformat -%Y-%m-%d
    copytruncate
    
    postrotate
        # Reload PM2 logs
        su - viwoapp -c "pm2 reloadLogs" > /dev/null 2>&1 || true
    endscript
}

# ==========================================
# Nginx Logs (if using local nginx)
# ==========================================
/var/log/nginx/viwoapp-*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 www-data adm
    dateext
    dateformat -%Y-%m-%d
    sharedscripts
    
    postrotate
        # Reload nginx
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

# ==========================================
# Backup Logs
# ==========================================
/var/www/viwoapp/logs/backup.log {
    weekly
    rotate 12
    compress
    delaycompress
    missingok
    notifempty
    create 0640 viwoapp viwoapp
    dateext
    dateformat -%Y-%m-%d
}

# ==========================================
# Size-based Rotation (for high-traffic logs)
# ==========================================
/var/www/viwoapp/backend/logs/error*.log {
    # Rotate when file reaches 100MB
    size 100M
    
    # Keep 5 rotated logs
    rotate 5
    
    compress
    delaycompress
    missingok
    notifempty
    create 0640 viwoapp viwoapp
    dateext
    dateformat -%Y-%m-%d-%s
    
    postrotate
        # Alert on error log rotation (optional)
        # echo "Error log rotated on $(date)" | mail -s "ViWoApp Error Log Rotated" admin@example.com
    endscript
}

